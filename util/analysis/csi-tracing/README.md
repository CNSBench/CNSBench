# CSI Tracing Utility

A standalone utility that parses pcap files to extract timing information
about CSI (Container Storage Interface) calls.

## Usage  
#### Compile & run source code:   
```
$ go run ./*.go [filename]
```
#### Compile source code to executable & run:  
```
$ go build -o csitrace
$ ./csitrace [filename]
```

## Implementation overview  

```
csi-tracing
|-- README.md
|-- main.go
|-- tologs.go
|-- timing.go
|-- types.go
|-- pcap.go
|-- http2.go
|-- grpc.go
|-- csi.go
`-- csi.pb.go
```

### main.go
#### func main()
Calls [`pcapToLogs(filename)`](#func-pcapToLogs(fileName)) to extract CSI
calls and their timing information into [`CsiLog`](#type-CsiLog) structs.  
Prints each log to stdout after converting them to json format using
[`toJson(log)`](#func-toJson(log-CsiLog)-string).

### tologs.go
Defines type CsiLog, functions toJson and pcapToLogs and their helpers.
#### type CsiLog
A struct that represents a single CSI call (request and response),
containing information about the call.  

Timing information:
- start: timestamp of the CSI request
- end: timestamp of the CSI response
- duration: time between start and end, in nanoseconds.

#### func toJson(log CsiLog) string
Marshals a [`CsiLog`](#type-CsiLog) into JSON format, converts it to a string,
and returns the JSON string.

#### func pcapToLogs(fileName string) []CsiLog 
Calls [`parseCSIPcapFile(fileName)`](#func-parseCSIPcapFile(fileName-string)-[]CsiRPC) to
parse the pcap file into a slice of [`CsiRPC`](#type-CsiRPC) structs, then
calls [`extractLogs(rpcs)`](#func-extractLogs(rpcs)) to convert the
[`CsiRPC`](#type-CsiRPC) structs to [`CsiLog`](#type-CsiLog) structs.

### timing.go
Defines function sortRPCs and its helpers.
Used by `parseCSIPcapFile` in `tologs.go`.
#### func sortRPCs(rpcs []CsiRPC)
Sorts a slice of [`CsiRPCs`](#type-CsiRPC) by their response time, in
increasing order.

### types.go
Defines some structs used for parsing packets that are referred to
in several different source files.
#### type CsiRPC
Stores information about a CSI gRPC call, including the type of call,
the request and response, and their timestamps.
#### type rawFrames
Stores all HTTP2 frames sent from a source to a destination.
#### type frames
Stores all HTTP2 frames found in a single packet.
#### type rawStreams
Stores all streams exchanged between two hosts.
#### stream
Stores frames from a source to a destination that belong to the same
stream, accompanied by the timestamp of the last frame.
#### type frame
A single HTTP2 frame.

### pcap.go
Defines function parsePackets and its helpers.
Used by `parseCSIPcapFile` in `tologs.go`.
#### func parsePackets(fileName string) map[string]rawFrames
Parses the pcap file at fileName and returns a map:
- key: each unique source-destination IP+port pair
- value: the collection of all HTTP2 frames that were sent from the source host to the destination host.  

### http2.go
Defines function extractStreams and its helpers.
Used by `parseCSIPcapFile` in `tologs.go`.
#### func extractStreams(rfs map[string]rawFrames) []rawStreams
Matches each rawFrames with another rawFrames that contains frames
sent in the opposite direction between the same hosts and ports.
Combines the pair of rawFrames into a new rawStreams.

### grpc.go
Defines function parseRPCs and its helpers.
Used by `parseCSIPcapFile` in `tologs.go`.
#### func parseRPCs(rawstreams []rawStreams) []CsiRPC
For each [`rawStreams`](#type-rawStreams) struct, containing HTTP2 frames
between two hosts, identifies the CSI gRPC request and response and saves them to a
[`CsiRPC`](#type-CsiRPC) struct.

### csi.go
Defines functions parseCSIRequest and parseCSIResponse, and their helpers.
These functions are used by `parseGRPC` in `grpc.go`.

### csi.pb.go
This file is generated by [protoc-gen-go](https://developers.google.com/protocol-buffers/docs/gotutorial#compiling-your-protocol-buffers),
a tool that converts Google protobuf files to Go code.
It's an auto-generated Go representation of the CSI protocol.
